name: Auto update AUR packages

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "只测试（更新/计算校验和/生成 .SRCINFO/commit），不 push 到 AUR"
        type: boolean
        default: true
      pkgname:
        description: "只更新指定 AUR 包名（留空则按 config/packages.json 全部更新）"
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: aur-autoupdate
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Checkout updater repo
        uses: actions/checkout@v4

      - name: Install dependencies (Arch)
        run: |
          set -euo pipefail
          pacman -Syu --noconfirm --needed \
            git openssh curl jq perl \
            pacman-contrib libarchive rsync \
            sudo namcap

      - name: Create non-root user for makepkg
        run: |
          set -euo pipefail
          useradd -m -U builder
          chown -R builder:builder /home/builder
          echo 'builder ALL=(ALL) NOPASSWD: /usr/bin/pacman' > /etc/sudoers.d/builder-pacman
          chmod 440 /etc/sudoers.d/builder-pacman

      - name: Configure SSH key for AUR
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          AUR_KNOWN_HOSTS: ${{ secrets.AUR_KNOWN_HOSTS }}
        run: |
          set -euo pipefail
          [[ -n "${AUR_SSH_PRIVATE_KEY:-}" ]] || { echo "Missing secret: AUR_SSH_PRIVATE_KEY" >&2; exit 1; }

          install -d -m 700 /home/builder/.ssh
          printf '%s\n' "${AUR_SSH_PRIVATE_KEY}" | tr -d '\r' > /home/builder/.ssh/id_ed25519
          chmod 600 /home/builder/.ssh/id_ed25519

          if [[ -n "${AUR_KNOWN_HOSTS:-}" ]]; then
            printf '%s\n' "${AUR_KNOWN_HOSTS}" > /home/builder/.ssh/known_hosts
          else
            ssh-keyscan -H aur.archlinux.org > /home/builder/.ssh/known_hosts
          fi
          chmod 600 /home/builder/.ssh/known_hosts
          chown -R builder:builder /home/builder/.ssh

      - name: Update & push to AUR
        env:
          ONLY_PKGNAME: ${{ github.event.inputs.pkgname }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' && '1' || '0' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKDIR: /home/builder/_work
          GIT_SSH_COMMAND: ssh -i /home/builder/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes
        run: |
          set -euo pipefail
          su - builder -c "cd '${GITHUB_WORKSPACE}' && env ONLY_PKGNAME='${ONLY_PKGNAME}' DRY_RUN='${DRY_RUN}' WORKDIR='${WORKDIR}' GITHUB_TOKEN='${GITHUB_TOKEN}' GIT_SSH_COMMAND='${GIT_SSH_COMMAND}' bash scripts/update-all.sh"

      - name: Write run report (Job Summary)
        if: always()
        env:
          REPORT_JSON: /home/builder/_work/report.jsonl
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' && '1' || '0' }}
        run: |
          set -euo pipefail

          {
            echo "## 本次执行报告"
            echo ""
            echo "- 时间（UTC）：$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo "- 触发方式：${GITHUB_EVENT_NAME}"
            echo "- Dry run：${DRY_RUN:-unknown}"
            echo ""
          } >> "${GITHUB_STEP_SUMMARY}"

          if [[ ! -f "${REPORT_JSON}" ]]; then
            echo "- 未生成报告文件：\`${REPORT_JSON}\`" >> "${GITHUB_STEP_SUMMARY}"
            exit 0
          fi

          echo "| 包名 | 状态 | 当前版本 | 最新版本 | commit | pushed | 备注 |" >> "${GITHUB_STEP_SUMMARY}"
          echo "|---|---|---:|---:|---|---:|---|" >> "${GITHUB_STEP_SUMMARY}"
          if jq -sr '.' "${REPORT_JSON}" >/dev/null 2>&1; then
            jq -sr '
              .[] |
              [
                (.pkgname // "-"),
                (.status // "-"),
                (.current_pkgver // "-"),
                (.latest_pkgver // "-"),
                (.commit_sha // "-"),
                ((.pushed|tostring) // "0"),
                ((.note // "-") | gsub("[\\r\\n]+"; " ") | gsub("\\|"; "\\\\|"))
              ] |
              "| " + (.[0:7] | join(" | ")) + " |"
            ' "${REPORT_JSON}" >> "${GITHUB_STEP_SUMMARY}"
            failed_count="$(jq -sr '[.[] | select(.status=="failed")] | length' "${REPORT_JSON}")"
          else
            echo "| - | failed | - | - | - | 0 | 报告文件解析失败，已附加原始内容 |" >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo '```' >> "${GITHUB_STEP_SUMMARY}"
            sed -n '1,200p' "${REPORT_JSON}" >> "${GITHUB_STEP_SUMMARY}"
            echo '```' >> "${GITHUB_STEP_SUMMARY}"
            failed_count="unknown"
          fi
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "- 失败数量：${failed_count}" >> "${GITHUB_STEP_SUMMARY}"
